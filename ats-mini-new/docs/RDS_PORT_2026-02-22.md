# FM RDS Port Status (2026-02-22)

> Status (2026-02-26): Historical planning/assessment/session document.
> It may not reflect the current firmware implementation exactly. For current implementation docs, use docs/ARCHITECTURE.md, docs/FIRMWARE_MAP.md, docs/ETM_SCAN.md, docs/UI_INTERACTION_SPEC.md, and source under src/ and include/


This document records the FM RDS/CT port work completed in this session, including architecture changes, UI behavior, decoder heuristics, bug fixes, and test snapshots.

## Scope completed

- Added a dedicated `rds_service` for FM RDS decode, voting, quality, stale policy, and committed UI-facing fields.
- Added a dedicated `clock_service` so RDS CT can update displayed time without putting time logic in `ui_service`.
- Extended `AppState` with explicit `RdsState` and `ClockState`.
- Added a radio-side raw RDS group snapshot polling API (`pollRdsGroup`) and decoder reset hook.
- Updated settings and persistence for the new four-mode RDS contract.
- Updated Now Playing UI layout for PS/RT/PI/PTY placement.
- Built test snapshots for on-device validation.

## RDS mode contract (implemented)

User-facing modes:

- `Off`
- `PS`
- `Full-CT` (internal enum `FullNoCt`)
- `ALL`

Behavior:

- `Off`: no RDS fields shown; FM PS slot is blank (no placeholder).
- `PS`: show PS only.
- `Full-CT`: show PS + RT + PI + PTY, but do not apply CT to the clock.
- `ALL`: show PS + RT + PI + PTY and apply CT to the displayed clock.

Region/PTy naming:

- `FmRegion::US` uses RBDS PTY labels.
- Other regions use RDS PTY labels.

## Architecture changes

### New services

- `src/services/rds_service.cpp`
  - Polls raw RDS groups from `radio_service`
  - Decodes PI/PS/RT/PTY/CT
  - Applies vote/quality/commit/stale policy
  - Commits stable fields into `AppState::rds`
- `src/services/clock_service.cpp`
  - Maintains display clock in `AppState::clock`
  - Uses synthetic clock when no CT base is active
  - Applies `utcOffsetMinutes` after CT-backed UTC base is set

### Main coordinator integration

`src/main.cpp` now ticks:

- `services::rds::tick(g_state)`
- `services::clock::tick(g_state)`

This preserves the service-oriented coordinator model in `docs/ARCHITECTURE.md`.

### Radio service integration

`src/services/radio_service.cpp` changes:

- Local SI4735 subclass used to expose raw RDS status snapshots without patching the global library install.
- FM-mode RDS config/flush support added.
- `pollRdsGroup(...)` returns one decoded raw group snapshot (blocks A/B/C/D, BLE, group metadata).
- `resetRdsDecoder()` clears library-side RDS buffers/FIFO on retune/reset.

## Decode strategy

- Decode attempts are not blocked by a hard SNR threshold.
- BLE validation and commit quality gates are used to keep the UI stable.
- Seek/scan activity pauses active RDS processing and resets state at context transitions.

## Signal-scale parity (PI/PS/RT)

The PI/PS/RT commit and stale heuristics were aligned to signal-scale:

- `RDS_CHECK_GROUPS_PER_TICK = 4`
- `RDS_UI_COMMIT_MIN_MS = 500`
- `RDS_QUALITY_MIN_BUFFER = 30`
- `RDS_QUALITY_MIN_COMMIT = 45`
- PI vote window + lock/change thresholds
- PS per-segment vote windows + PS freshness window
- RT A/B debounce + partial commit threshold
- Hold/stale clear behavior (`RDS_HOLD_MS`, `RDS_STALE_CLEAR_MS`)

Notes:

- CT handling keeps an extra local sanity/debounce layer (hours/minutes validity and bounded commit behavior) before clock updates.
- This is intentional safety logic for station clock quality and is not a 1:1 signal-scale CT path.

## UI changes (Now Playing / FM)

Implemented UI placement changes:

- PS uses the former `RDS ---` FM name slot (center area).
- RT replaces the old `RSSI:%u SNR:%u` text line in FM mode.
- PI and PTY render under the clock cluster.
- Bottom signal bars remain signal instrumentation.

Placeholder policy:

- `RDS ---` placeholder has been removed from the FM PS slot.
- When PS is not yet committed (or RDS is off), the PS slot is blank.

Additional UI tweak from this session:

- Large frequency display moved down by `+2 px` (`kFreqY` changed from `58` to `60` in `ui_service.cpp`).

## Settings / persistence changes

`include/settings_model.h` and `src/services/settings_service.cpp` updated for the 4-mode contract:

- Labels:
  - `Off`
  - `PS`
  - `Full-CT`
  - `ALL`
- Persistence migration/sanitize behavior:
  - Legacy invalid/out-of-range values clamp to `PS`
  - Existing mode values map safely into the new enum range

## Bugs found and fixed during integration

### 1) PS not committing while RT worked

Symptom:

- Radio text (RT) appeared, but the PS slot stayed empty / placeholder.

Cause:

- Group 0 PS segment addressing incorrectly used the generic 4-bit segment field.
- PS address for group 0 is the lower 2 bits of block B.

Fix:

- `processPsGroup(...)` now uses `snap.blockB & 0x03`.

### 2) FM PS placeholder stayed visible

Symptom:

- `RDS ---` remained visible in the FM PS slot.

Cause:

- UI helper explicitly generated `RDS ---` for RDS-off and no-PS cases.

Fix:

- Removed placeholder generation for FM PS slot; UI renders blank until real PS is committed.

## Test snapshots built in this session

Built snapshots under `../test-builds/snapshots/`:

- `2026-02-22-031648-rds-signal-scale-heuristics`
  - Signal-scale PI/PS/RT heuristics port
- `2026-02-22-032937-rds-ps-placeholder-fix`
  - RDS placeholder removal and PS decode fix pass (pre-frequency-Y tweak)
- `2026-02-22-033039-freq-y-plus2-rds-fix`
  - Latest snapshot (includes PS decode fix, placeholder removal, and frequency `+2 px`)

Latest snapshot pointer:

- `../test-builds/snapshots/LATEST_SNAPSHOT.txt`

Latest snapshot build stats (`2026-02-22-033039-freq-y-plus2-rds-fix`):

- Flash: `459743 bytes (2%)`
- RAM: `30536 bytes (9%)`

## Files changed (high level)

- `include/app_state.h`
- `include/app_services.h`
- `include/settings_model.h`
- `src/main.cpp`
- `src/services/radio_service.cpp`
- `src/services/settings_service.cpp`
- `src/services/ui_service.cpp`
- `src/services/rds_service.cpp` (new)
- `src/services/clock_service.cpp` (new)

## Hardware validation still needed

- Weak-station FM RDS accumulation and UI stability tuning
- CT reliability across multiple stations/markets
- Real-world PTY label verification by region (US RBDS vs non-US RDS)
- Scan/seek transition resets with live on-device behavior checks
